/*
 * This is sample code generated by rpcgen.
 * These are only templates and you can use them
 * as a guideline for developing your own functions.
 */

#include "sxfs.h"
#include "peer_info.h"
#include <sstream>
using namespace std;

static map<pair<string,int>,string> clientList;
static map<pair<string,int>,string >::iterator it = clientList.begin();

void outputClientList() {
	cout << "outputing server list:" << endl;
	map<pair<string,int>, string >::iterator iter;
	for (iter = clientList.begin(); iter != clientList.end(); ++iter) {
		cout << iter->first.first << ":" << iter->first.second << " : " << iter->second.c_str() << endl;
	}
}

node_list *file_find_1_svc(char *arg1,  struct svc_req *rqstp) {
	static node_list result;
	result.node_list_val = new node[clientList.size()];
	result.node_list_len = 0;
	client_file_list f_list;
	int pos = -1;
	int len = 0;
    strcat(arg1, " "); //appending a space so it actually searches for entire word and not any substring in filename
    cout << "node list is: \n";
	map<pair<string,int>, string >::iterator iter;
 	for (iter = clientList.begin(); iter != clientList.end(); ++iter) {
		f_list = new char[(iter->second).length() +1];
		strcpy(f_list,iter->second.c_str());
		string remaining_list(f_list, strlen(f_list));
		pos = remaining_list.find(arg1);
		if(pos >= 0){
			node *temp_node = result.node_list_val + len;
			temp_node->ip= new char[MAXIP];
			strcpy(temp_node->ip,iter->first.first.c_str());
			temp_node->port = iter->first.second;
			cout << temp_node->ip << ":" << temp_node->port << "\n";
            result.node_list_len++;
			len++;
			continue;
		}
		pos = -1;
	}
	return &result;
}

int *update_list_1_svc(IP arg1, int arg2, client_file_list arg3, struct svc_req *rqstp) {
	static int  result = -1;
	stringstream self_file_list;
	self_file_list << arg3;
	map<pair<string,int>,string >::iterator find_itr;
	find_itr = clientList.find(make_pair(arg1,arg2));
	//add client to client list only if previously not existing
	if(find_itr == clientList.end()) {
		clientList.insert (it, std::pair<pair<string,int>,string >(make_pair(arg1,arg2), self_file_list.str()));
		it++;
	}
	outputClientList();
	result = 0;
	return &result;
}

int *remove_client_1_svc(IP arg1, int arg2, struct svc_req *rqstp) {
    static int  result = -1;
    //removal of client from list when it fails
    map<pair<string,int>,string >::iterator find_itr;
    find_itr = clientList.find(make_pair(arg1,arg2));
    if(find_itr != clientList.end()) {
        clientList.erase(find_itr);
    }
    outputClientList();
    result = 0;
    return &result;
}

int *
ping_1_svc(struct svc_req *rqstp) {
    static int err_code = -1;

    std::cout << "ping received\n";
    err_code = 0;

    return &err_code;
}
